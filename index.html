<!DOCTYPE html>
<html>
<head>
<style>
    .table-box {
        display: inline-block;
        margin-right: 40px;
        vertical-align: top;
    }

    table {
        border-collapse: collapse;
        margin-top: 10px;
        table-layout: fixed;
        white-space: nowrap;
        font-family: Arial, sans-serif;
        font-size: 14px;
        width: 700px;
        border: 1px solid #999;
    }

    th, td {
        border: 1px solid #999;
        padding: 4px 6px;
        text-align: left;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    th {
        background: #f0f0f0;
        font-weight: bold;
    }

    .claimed {
        background: #c8f7c5;
        color: #155724;
        font-weight: bold;
    }

    .missed {
        background: #f8d0d0;
        color: #8b0000;
        font-weight: bold;
    }

    .header-title {
        background: #e2e2ff;
        font-size: 16px;
        text-align: center;
    }

    .header-info {
        background: #f9f9f9;
        font-size: 14px;
    }
</style>
</head>
<body>

<div id="result"></div>

<script>
/* -----------------------------
   DATE HELPERS (no timezones)
------------------------------*/
function parseTS(ts) { return new Date(ts.replace(" ", "T")); }

function getDayRange(purchaseTS, dayIndex) {
    const start = new Date(purchaseTS);
    let day1End = new Date(start);
    day1End.setHours(8, 0, 0, 0);

    if (start.getHours() >= 8) {
        day1End.setDate(day1End.getDate() + 1);
    }

    let rangeStart, rangeEnd;

    if (dayIndex === 1) {
        rangeStart = start;
        rangeEnd = day1End;
    } else {
        rangeStart = new Date(day1End);
        rangeStart.setDate(rangeStart.getDate() + (dayIndex - 2));

        rangeEnd = new Date(rangeStart);
        rangeEnd.setDate(rangeEnd.getDate() + 1);
        rangeEnd.setHours(8, 0, 0, 0);
    }

    return { start: rangeStart, end: rangeEnd };
}

function formatTS(d) {
    return d.getFullYear() + "-" +
        String(d.getMonth()+1).padStart(2,"0") + "-" +
        String(d.getDate()).padStart(2,"0") + " " +
        String(d.getHours()).padStart(2,"0") + ":" +
        String(d.getMinutes()).padStart(2,"0");
}

function isWithin(ts, range) {
    return ts >= range.start && ts <= range.end;
}

/* -----------------------------
   MAIN TABLE GENERATOR
------------------------------*/
function createSubscriptionTable(subName, purchaseTS, count, claims) {
    const totalDays = count * 7;
    const purchaseDate = parseTS(purchaseTS);

    let earliestStart = purchaseDate;
    let finalEnd;

    const tableBox = document.createElement("div");
    tableBox.className = "table-box";

    const table = document.createElement("table");

    /* Force column widths */
    const colgroup = document.createElement("colgroup");
    const colDay = document.createElement("col"); colDay.style.width = "60px";
    const colRange = document.createElement("col"); colRange.style.width = "480px";
    const colStatus = document.createElement("col"); colStatus.style.width = "100px";
    const colBlank = document.createElement("col"); colBlank.style.width = "60px";
    colgroup.appendChild(colDay);
    colgroup.appendChild(colRange);
    colgroup.appendChild(colStatus);
    colgroup.appendChild(colBlank);
    table.appendChild(colgroup);

    /* ROW 1 – Header */
    let row1 = table.insertRow();
    let cell1 = row1.insertCell();
    cell1.colSpan = 4;
    cell1.className = "header-title";
    cell1.textContent = subName;

    /* Compute full date range */
    let lastRange = getDayRange(purchaseDate, totalDays);
    finalEnd = lastRange.end;

    /* ROW 2 – Total days + start/end */
    let row2 = table.insertRow();
    let c2 = row2.insertCell();
    c2.colSpan = 4;
    c2.className = "header-info";
    c2.textContent =
        `Total: ${totalDays} days | Start: ${formatTS(earliestStart)} | End: ${formatTS(finalEnd)}`;

    /* ROW 3 – Column headers */
    let header = table.insertRow();
    header.innerHTML =
        "<th>Day</th><th>Day Range</th><th>Status</th><th></th>";

    /* ROWS 4+ – Day rows */
    for (let d = 1; d <= totalDays; d++) {
        const row = table.insertRow();

        const r = getDayRange(purchaseDate, d);

        let status = "Missed";
        let cssClass = "missed";

        for (let cl of claims) {
            const clTS = parseTS(cl);
            if (isWithin(clTS, r)) {
                status = "Claimed (" + cl + ")";
                cssClass = "claimed";
                break;
            }
        }

        row.insertCell().textContent = "Day " + d;
        row.insertCell().textContent = `${formatTS(r.start)} → ${formatTS(r.end)}`;

        let cStatus = row.insertCell();
        cStatus.textContent = (status.startsWith("Claimed") ? status : "Missed");
        cStatus.className = cssClass;

        row.insertCell().textContent = ""; // blank column
    }

    tableBox.appendChild(table);
    return tableBox;
}

/* -----------------------------
   SIMULATION (example)
------------------------------*/

document.getElementById("result").appendChild(
    createSubscriptionTable(
        "Sub Pack 07",
        "2025-11-28 15:37",
        2, // extended → 14 days
        [
            "2025-11-28 19:16:13",
            "2025-11-29 12:05:04",
            "2025-11-30 21:42:53",
            "2025-12-01 20:58:21",
            "2025-12-02 15:37:31",
            "2025-12-03 19:17:11"
        ]
    )
);

document.getElementById("result").appendChild(
    createSubscriptionTable(
        "Sub Pack 30",
        "2025-12-01 15:37",
        1, // only 7 days
        []
    )
);
</script>
</body>
</html>
