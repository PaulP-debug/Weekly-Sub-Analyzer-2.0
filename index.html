<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subscription Analyzer</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  textarea { width: 100%; height: 150px; margin-bottom: 10px; font-family: monospace; }
  table { border-collapse: collapse; margin-bottom: 30px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  .header { font-weight: bold; background-color: #e0e0e0; }
  .claimed { background-color: #d4edda; }
  .missed { background-color: #f8d7da; }
</style>
</head>
<body>

<h2>Subscription Analyzer</h2>

<h3>Paste Purchase Data (7 columns, tab-delimited)</h3>
<textarea id="purchaseData" placeholder="Paste purchase data here..."></textarea>

<h3>Paste Claim Data (9 columns, tab-delimited)</h3>
<textarea id="claimData" placeholder="Paste claim data here..."></textarea>

<button onclick="analyze()">Analyze</button>

<div id="result"></div>

<script>
const PACKS = {
  7.00: {name: "Sub Pack 07", sc: 0.50, gc: 2000, duration: 7},
  30.00: {name: "Sub Pack 30", sc: 2.00, gc: 10000, duration: 7},
  90.00: {name: "Sub Pack 90", sc: 5.50, gc: 40000, duration: 7},
};

const UTC_OFFSET = -8; // server time (PST)

function parsePurchases(text) {
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  const purchases = [];
  for (let i=0; i<lines.length; i++) {
    if (lines[i].toLowerCase() === "sub_pack") {
      const prevLine = lines[i-1] || "";
      const tsStr = prevLine.split("\t")[0];
      const amtLine = lines[i+1] || lines[i];
      const amount = parseFloat(amtLine.match(/\d+(\.\d+)?/)[0]);
      if (PACKS[amount]) {
        purchases.push({ts: new Date(tsStr), amount: amount, pack: PACKS[amount].name});
      }
    }
  }
  return purchases.sort((a,b)=>a.ts-b.ts);
}

function parseClaims(text) {
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  const claims = [];
  for (let i=0; i<lines.length; i++) {
    const cols = lines[i].split("\t");
    if (cols.length < 9) continue;
    const sc = parseFloat(cols[0]);
    const gc = parseInt(parseFloat(cols[1]));
    const tsStr = cols[cols.length-1];
    const ts = new Date(tsStr);
    let packName = null;
    for (const amt in PACKS) {
      if (PACKS[amt].sc === sc && PACKS[amt].gc === gc) {
        packName = PACKS[amt].name; break;
      }
    }
    if (packName) claims.push({ts, pack: packName});
  }
  return claims.sort((a,b)=>a.ts-b.ts);
}

// Add days in array from start date considering UTC-8 reset at 08:00
function computeDayWindows(start, durationDays) {
  const days = [];
  const startUTC0 = new Date(start);
  for (let i=0;i<durationDays;i++) {
    let dayStartUTC8;
    if (i===0) {
      dayStartUTC8 = new Date(startUTC0.getTime() + UTC_OFFSET*3600*1000);
    } else {
      dayStartUTC8 = new Date(days[i-1].endUTC8.getTime());
    }
    // Day end at next 08:00 UTC-8
    const endUTC8 = new Date(dayStartUTC8.getTime());
    endUTC8.setUTCHours(8,0,0,0);
    if (endUTC8<=dayStartUTC8) endUTC8.setUTCDate(endUTC8.getUTCDate()+1);
    const startUTC0Final = new Date(dayStartUTC8.getTime() - UTC_OFFSET*3600*1000);
    const endUTC0Final = new Date(endUTC8.getTime() - UTC_OFFSET*3600*1000);
    days.push({startUTC0:startUTC0Final, endUTC0:endUTC0Final, startUTC8:dayStartUTC8, endUTC8:endUTC8});
  }
  return days;
}

function analyze() {
  const purchaseText = document.getElementById("purchaseData").value;
  const claimText = document.getElementById("claimData").value;
  const purchases = parsePurchases(purchaseText);
  const claims = parseClaims(claimText);

  // compute intervals with extension
  const intervals = {};
  for (const p of purchases) {
    if (!intervals[p.pack]) intervals[p.pack] = [];
    let lastInterval = intervals[p.pack][intervals[p.pack].length-1];
    let start = p.ts;
    if (lastInterval && start <= lastInterval.end) start = lastInterval.end;
    const end = new Date(start.getTime() + PACKS[p.amount].duration*24*3600*1000);
    intervals[p.pack].push({start, end, original: p.ts, amount: p.amount});
  }

  const container = document.getElementById("result");
  container.innerHTML = "";

  for (const pack in intervals) {
    for (const interval of intervals[pack]) {
      // Determine claim days
      const totalDays = Math.ceil((interval.end - interval.start)/(24*3600*1000));
      const dayWindows = [];
      let dayStart = new Date(interval.start);
      for (let d=0; d<totalDays; d++) {
        const dayEnd = new Date(dayStart.getTime() + 24*3600*1000);
        dayWindows.push({dayStart: new Date(dayStart), dayEnd});
        dayStart = new Date(dayEnd);
      }

      const rows = [];
      for (let i=0;i<dayWindows.length;i++) {
        const day = dayWindows[i];
        let claim = claims.find(c => c.pack===pack && c.ts>=day.dayStart && c.ts<day.dayEnd);
        let status = claim ? "Claimed" : "Missed";
        const now = new Date();
        if (day.dayStart>now) status="Future";
        rows.push({day:`Day ${i+1}`, backend: claim?formatDateUTC0(claim.ts):status, pst: claim?formatDatePST(claim.ts):status, className: status.toLowerCase()});
      }

      // Header table
      const table = document.createElement("table");
      const header = table.insertRow();
      header.innerHTML = `<th colspan="2">${pack}</th>`;
      const rangeRow = table.insertRow();
      const startStr = formatDateUTC0(interval.start);
      const endStr = formatDateUTC0(interval.end);
      const startPST = formatDatePST(interval.start);
      const endPST = formatDatePST(interval.end);
      let extendedStr = (interval.original.getTime() !== interval.start.getTime()) ? ` (Extended)` : "";
      rangeRow.innerHTML = `<td>Backend: ${startStr} - ${endStr}${extendedStr}</td>
                            <td>Server Time: ${startPST} - ${endPST}${extendedStr}</td>`;

      // Days header
      const dayHeader = table.insertRow();
      dayHeader.innerHTML = `<th>Backend (UTC-0)</th><th>PST (UTC-8)</th>`;

      // Add days
      for (const r of rows) {
        const tr = table.insertRow();
        tr.className = r.className;
        tr.innerHTML = `<td>${r.day} - ${r.backend}</td><td>${r.pst}</td>`;
      }

      container.appendChild(table);
    }
  }
}

function formatDateUTC0(d) {
  const dt = new Date(d);
  return dt.getUTCFullYear()+"-"+pad(dt.getUTCMonth()+1)+"-"+pad(dt.getUTCDate())+" "+pad(dt.getUTCHours())+":"+pad(dt.getUTCMinutes());
}

function formatDatePST(d) {
  const dt = new Date(d.getTime() + UTC_OFFSET*3600*1000);
  return dt.getUTCFullYear()+"-"+pad(dt.getUTCMonth()+1)+"-"+pad(dt.getUTCDate())+" "+pad(dt.getUTCHours())+":"+pad(dt.getUTCMinutes());
}

function pad(n) { return n<10?"0"+n:n; }
</script>

</body>
</html>
