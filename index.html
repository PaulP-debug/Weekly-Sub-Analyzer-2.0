<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subscription Analyzer</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
textarea { width: 100%; height: 120px; margin-bottom: 10px; font-family: monospace; }
button { padding: 10px 20px; font-size: 16px; margin-bottom: 20px; }
.tables-container { display: flex; gap: 20px; flex-wrap: wrap; }

.table-box { display: inline-block; vertical-align: top; }
table { border-collapse: collapse; table-layout: fixed; white-space: nowrap; font-size: 14px; margin-bottom: 20px; }
th, td { border: 1px solid #999; padding: 4px 6px; text-align: left; overflow: hidden; text-overflow: ellipsis; }
th { background: #f0f0f0; font-weight: bold; }
.header-title { font-size: 16px; text-align: center; }
.header-title.sub7 { background: #cce5ff; }    /* light blue */
.header-title.sub30 { background: #d4edda; }   /* light green */
.header-title.sub90 { background: #fff3cd; }   /* light yellow */

.total-days { background: #fff3b0; font-weight: bold; text-align: center; } /* yellow highlight */
.claimed { background: #c8f7c5; color: #155724; font-weight: bold; }
.missed { background: #f8d0d0; color: #8b0000; font-weight: bold; }
</style>
</head>
<body>

<h2>Subscription Analyzer</h2>

<label>Paste Purchase Data (7-column table, tab-separated):</label>
<textarea id="purchaseData"></textarea>

<label>Paste Claim Data (3-line per claim):</label>
<textarea id="claimData"></textarea>

<button onclick="analyze()">Analyze</button>

<div id="results" class="tables-container"></div>

<script>
const PACKS = {
  7.00: {name: "Sub Pack 07", sc: 0.50, gc: 2000},
  30.00: {name: "Sub Pack 30", sc: 2.00, gc: 10000},
  90.00: {name: "Sub Pack 90", sc: 5.50, gc: 40000}
};

// ------------------ Parse Purchases ------------------
function parsePurchases(text){
  const lines = text.trim().split('\n').map(l=>l.trim()).filter(l=>l);
  const purchases=[];
  for(let i=0;i<lines.length;i++){
    if(lines[i].toLowerCase().includes("sub_pack")){
      const prev = i>0 ? lines[i-1] : null;
      if(!prev) continue;
      const ts = new Date(prev.split("\t")[0]);
      const nextLine = (i+1)<lines.length ? lines[i+1] : lines[i];
      const amtMatch = nextLine.match(/\d+(\.\d+)?/);
      if(!amtMatch) continue;
      const amt = parseFloat(amtMatch[0]);
      if(PACKS[amt]) purchases.push({purchase_ts: ts, pack_amount: amt, pack_name: PACKS[amt].name});
    }
  }
  return purchases;
}

// ------------------ Parse Claims ------------------
function parseClaims(text){
  const lines = text.trim().split('\n').map(l=>l.trim()).filter(l=>l);
  const claims = [];
  for(let i=0;i<lines.length;i+=3){
    const line1 = lines[i].split(/\s+/);
    if(line1.length < 2) continue;
    const sc = parseFloat(line1[0]);
    const gc = parseFloat(line1[1]);
    const line3 = lines[i+2] || '';
    const dateMatch = line3.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);
    if(!dateMatch) continue;
    const ts = new Date(dateMatch[0]);

    // Determine pack type based on SC + GC
    let pack_amount = null;
    for(let amt in PACKS){
      if(PACKS[amt].sc === sc && PACKS[amt].gc === gc){
        pack_amount = parseFloat(amt);
        break;
      }
    }
    if(pack_amount) claims.push({pack_amount, claim_ts: ts});
  }
  return claims;
}

// ------------------ Compute Intervals ------------------
function computeIntervals(purchases){
  const intervals=[];
  for(let amt in PACKS){
    const packName = PACKS[amt].name;
    let packPurchases = purchases.filter(p=>p.pack_amount==parseFloat(amt)).sort((a,b)=>a.purchase_ts-b.purchase_ts);
    let currentEnd=null;
    for(let p of packPurchases){
      let start=p.purchase_ts;
      if(currentEnd && start<=currentEnd) start=currentEnd;
      intervals.push({pack_name: packName, pack_amount: parseFloat(amt), purchase_ts:start});
      currentEnd = new Date(start.getTime() + 7*24*3600*1000);
    }
  }
  return intervals.sort((a,b)=>a.purchase_ts-b.purchase_ts);
}

// ------------------ Compute Day Ranges ------------------
function computeDayRanges(purchase_ts, totalDays){
  const ranges=[];
  let start = new Date(purchase_ts);
  for(let d=1; d<=totalDays; d++){
    let end = new Date(start);
    if(d===1){
      if(start.getHours()>=8){
        end.setDate(end.getDate()+1);
      }
      end.setHours(8,0,0,0);
    } else {
      start = new Date(ranges[ranges.length-1].end);
      end = new Date(start);
      end.setDate(end.getDate()+1);
      end.setHours(8,0,0,0);
    }
    ranges.push({day:d, start:new Date(start), end:new Date(end)});
    start = end;
  }
  return ranges;
}

// ------------------ Format Date ------------------
function formatDate(date){
  const pad = n=>n.toString().padStart(2,"0");
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

// ------------------ Create Table ------------------
function createTable(interval, totalDays, claims){
  const tableBox=document.createElement("div");
  tableBox.className="table-box";

  const table=document.createElement("table");

  // Row 1: Header with different colors
  let row1 = table.insertRow();
  let c1 = row1.insertCell();
  c1.colSpan = 4;
  c1.className = "header-title";
  if(interval.pack_amount === 7) c1.classList.add("sub7");
  else if(interval.pack_amount === 30) c1.classList.add("sub30");
  else if(interval.pack_amount === 90) c1.classList.add("sub90");
  c1.innerText = interval.pack_name;

  // Row 2: Total days | Start-End
  let row2 = table.insertRow();
  let c2a = row2.insertCell();
  c2a.innerText = `Total: ${totalDays} days`;
  c2a.className = "total-days"; // highlight in yellow
  let c2b = row2.insertCell();
  c2b.colSpan = 3;
  const lastRange = computeDayRanges(interval.purchase_ts, totalDays);
  c2b.innerText = `Start: ${formatDate(lastRange[0].start)} | End: ${formatDate(lastRange[lastRange.length-1].end)}`;

  // Row 3: Column headers
  let row3=table.insertRow();
  ["Day","Day Range","Status","Server Time"].forEach(h=>{
    let th=document.createElement("th"); th.innerText=h; row3.appendChild(th);
  });

  // Rows 4+: Day data
  lastRange.forEach(r=>{
    let row=table.insertRow();
    row.insertCell().innerText="Day "+r.day;
    row.insertCell().innerText=`${formatDate(r.start)} â†’ ${formatDate(r.end)}`;

    let statusCell = row.insertCell();
    let pstCell = row.insertCell();

    let matchedClaim = claims.find(c=>c.pack_amount===interval.pack_amount && c.claim_ts>=r.start && c.claim_ts<=r.end);
    if(matchedClaim){
      // Status: "Claimed: YYYY-MM-DD HH:MM"
      const claimText = formatDate(matchedClaim.claim_ts);
      statusCell.innerText = `Claimed: ${claimText}`;
      statusCell.className = "claimed";

      // Server Time = Column3 minus 8 hours (date adjusts automatically)
      let pstDate = new Date(matchedClaim.claim_ts);
      pstDate.setHours(pstDate.getHours() - 8);
      pstCell.innerText = formatDate(pstDate);
    } else {
      statusCell.innerText = "Missed";
      statusCell.className = "missed";
      pstCell.innerText = "";
    }
  });

  tableBox.appendChild(table);
  return tableBox;
}

// ------------------ Main Analyze ------------------
function analyze(){
  const purchases=parsePurchases(document.getElementById("purchaseData").value);
  const claims=parseClaims(document.getElementById("claimData").value);
  const resultsDiv=document.getElementById("results");
  resultsDiv.innerHTML="";

  // Prepare tables for each pack
  for(let amt in PACKS){
    const packName = PACKS[amt].name;
    let packPurchases = purchases.filter(p=>p.pack_amount===parseFloat(amt));
    if(packPurchases.length===0){
      const emptyInterval = {pack_name: packName, pack_amount:parseFloat(amt), purchase_ts:new Date()};
      resultsDiv.appendChild(createTable(emptyInterval, 0, claims));
      continue;
    }

    // Compute intervals
    let intervals=[];
    let currentEnd=null;
    packPurchases.sort((a,b)=>a.purchase_ts-b.purchase_ts).forEach(p=>{
      let start = p.purchase_ts;
      if(currentEnd && start <= currentEnd) start = currentEnd;
      intervals.push({pack_name: packName, pack_amount: parseFloat(amt), purchase_ts:start});
      currentEnd = new Date(start.getTime() + 7*24*3600*1000);
    });

    const totalDays = intervals.length * 7;
    resultsDiv.appendChild(createTable(intervals[0], totalDays, claims));
  }
}
</script>

</body>
</html>
