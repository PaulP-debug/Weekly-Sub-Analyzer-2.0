<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subscription Analyzer</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  textarea { width: 100%; height: 150px; margin-bottom: 10px; font-family: monospace; }
  table { border-collapse: collapse; margin-bottom: 30px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  .header { font-weight: bold; background-color: #e0e0e0; }
  .claimed { background-color: #d4edda; }
  .missed { background-color: #f8d7da; }
  .future { background-color: #fff3cd; }
</style>
</head>
<body>

<h2>Subscription Analyzer</h2>

<h3>Paste Purchase Data (7-column table, tab-separated)</h3>
<textarea id="purchaseData" placeholder="Paste purchase data here..."></textarea>

<h3>Paste Claim Data (9-column table, tab-separated)</h3>
<textarea id="claimData" placeholder="Paste claim data here..."></textarea>

<button onclick="analyze()">Analyze</button>

<div id="result"></div>

<script>
const PACKS = {
  7.00: {name: "Sub Pack 07", sc: 0.50, gc: 2000, duration: 7},
  30.00: {name: "Sub Pack 30", sc: 2.00, gc: 10000, duration: 7},
  90.00: {name: "Sub Pack 90", sc: 5.50, gc: 40000, duration: 7},
};
const UTC_OFFSET = -8; // server time (PST)

// ---------------- Parsing -----------------
function parsePurchases(text) {
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  const purchases = [];
  for (let i=0; i<lines.length; i++) {
    if (lines[i].toLowerCase() === "sub_pack") {
      const prevLine = lines[i-1] || "";
      const tsStr = prevLine.split("\t")[0];
      const amtLine = lines[i+1] || lines[i];
      const amount = parseFloat(amtLine.match(/\d+(\.\d+)?/)[0]);
      if (PACKS[amount]) purchases.push({ts: new Date(tsStr), amount: amount, pack: PACKS[amount].name});
    }
  }
  return purchases.sort((a,b)=>a.ts-b.ts);
}

function parseClaims(text) {
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  const claims = [];
  for (let i=0; i<lines.length; i++) {
    const cols = lines[i].split("\t");
    if (cols.length < 9) continue;
    const sc = parseFloat(cols[0]);
    const gc = parseInt(parseFloat(cols[1]));
    const tsStr = cols[cols.length-1];
    const ts = new Date(tsStr);
    let packName = null;
    for (const amt in PACKS) if (PACKS[amt].sc === sc && PACKS[amt].gc === gc) packName = PACKS[amt].name;
    if (packName) claims.push({ts, pack: packName});
  }
  return claims.sort((a,b)=>a.ts-b.ts);
}

// ---------------- Format -----------------
function formatDateUTC0(d) {
  const dt = new Date(d);
  return dt.getUTCFullYear()+"-"+pad(dt.getUTCMonth()+1)+"-"+pad(dt.getUTCDate())+" "+pad(dt.getUTCHours())+":"+pad(dt.getUTCMinutes());
}
function formatDatePST(d) {
  const dt = new Date(d.getTime() + UTC_OFFSET*3600*1000);
  return dt.getUTCFullYear()+"-"+pad(dt.getUTCMonth()+1)+"-"+pad(dt.getUTCDate())+" "+pad(dt.getUTCHours())+":"+pad(dt.getUTCMinutes());
}
function pad(n){return n<10?"0"+n:n;}

// ---------------- Analyze -----------------
function analyze() {
  const purchaseText = document.getElementById("purchaseData").value;
  const claimText = document.getElementById("claimData").value;
  const purchases = parsePurchases(purchaseText);
  const claims = parseClaims(claimText);
  const container = document.getElementById("result");
  container.innerHTML = "";

  // compute intervals with extension
  const intervals = {};
  for (const p of purchases) {
    if (!intervals[p.pack]) intervals[p.pack] = [];
    let lastInterval = intervals[p.pack][intervals[p.pack].length-1];
    let start = p.ts;
    if (lastInterval && start <= lastInterval.end) start = lastInterval.end;
    const end = new Date(start.getTime() + PACKS[p.amount].duration*24*3600*1000);
    intervals[p.pack].push({start, end, original: p.ts});
  }

  for (const pack in intervals) {
    for (const interval of intervals[pack]) {
      const now = new Date();

      // Compute number of days up to now
      const totalDays = Math.ceil((Math.min(interval.end, now) - interval.start)/(24*3600*1000));
      const totalDaysToShow = totalDays>0?totalDays:0;

      const rows = [];
      for (let i=0;i<totalDaysToShow;i++){
        const dayStart = new Date(interval.start.getTime() + i*24*3600*1000);
        const dayEnd = new Date(interval.start.getTime() + (i+1)*24*3600*1000);
        let claim = claims.find(c=>c.pack===pack && c.ts>=dayStart && c.ts<dayEnd);
        let status = claim?"Claimed":"Missed";
        rows.push({day:`Day ${i+1}`, backend: claim?formatDateUTC0(claim.ts):status, pst: claim?formatDatePST(claim.ts):status, className: status.toLowerCase()});
      }

      // Add future days
      const futureDays = Math.ceil((interval.end - Math.max(interval.start, now))/(24*3600*1000));
      for (let i=0;i<futureDays;i++){
        const dayNum = totalDaysToShow + i + 1;
        rows.push({day:`Day ${dayNum}`, backend:"Future", pst:"Future", className:"future"});
      }

      const table = document.createElement("table");

      // Pack Header
      const header = table.insertRow();
      header.innerHTML = `<th colspan="2">${pack}</th>`;

      // Range row
      const rangeRow = table.insertRow();
      const startStr = formatDateUTC0(interval.start);
      const endStr = formatDateUTC0(interval.end);
      const startPST = formatDatePST(interval.start);
      const endPST = formatDatePST(interval.end);
      const extendedStr = (interval.original.getTime()!==interval.start.getTime())?" (Extended)":"";
      rangeRow.innerHTML = `<td>Backend: ${startStr} - ${endStr}${extendedStr}</td>
                            <td>Server Time: ${startPST} - ${endPST}${extendedStr}</td>`;

      // Days Header
      const dayHeader = table.insertRow();
      dayHeader.innerHTML = `<th>Backend (UTC-0)</th><th>PST (UTC-8)</th>`;

      // Add day rows
      for (const r of rows) {
        const tr = table.insertRow();
        tr.className = r.className;
        tr.innerHTML = `<td>${r.day} - ${r.backend}</td><td>${r.pst}</td>`;
      }

      container.appendChild(table);
    }
  }
}
</script>

</body>
</html>
