<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subscription Analyzer</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  textarea { width: 100%; height: 120px; margin-bottom: 10px; font-family: monospace; }
  button { padding: 10px 20px; font-size: 16px; margin-bottom: 20px; }
  table { border-collapse: collapse; margin-bottom: 30px; width: 100%; }
  th, td { border: 1px solid #333; padding: 5px 10px; text-align: left; }
  th { background-color: #f2f2f2; }
  .header { background-color: #d9edf7; font-weight: bold; text-align: center; }
  .subheader { background-color: #fcf8e3; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<h2>Subscription Analyzer</h2>

<label>Paste Purchase Data (7-column table, tab-separated):</label>
<textarea id="purchaseData"></textarea>

<label>Paste Claim Data (9-column table, multi-line):</label>
<textarea id="claimData"></textarea>

<button onclick="analyze()">Analyze</button>

<div id="results"></div>

<script>
const PACKS = {
  7.00: {name: "Sub Pack 07", sc: 0.50, gc: 2000},
  30.00: {name: "Sub Pack 30", sc: 2.00, gc: 10000},
  90.00: {name: "Sub Pack 90", sc: 5.50, gc: 40000}
};
const SUB_DURATION_DAYS = 7;
const UTC_OFFSET = -8; // UTC-8

// Format Date as YYYY-MM-DD HH:MM:SS
function formatDate(date){
  if(!date) return "";
  const pad = n => n.toString().padStart(2,"0");
  const y = date.getUTCFullYear();
  const m = pad(date.getUTCMonth()+1);
  const d = pad(date.getUTCDate());
  const h = pad(date.getUTCHours());
  const min = pad(date.getUTCMinutes());
  const s = pad(date.getUTCSeconds());
  return `${y}-${m}-${d} ${h}:${min}:${s}`;
}

// Parse purchases
function parsePurchases(text){
  const lines = text.trim().split('\n').map(l=>l.trim()).filter(l=>l);
  const purchases=[];
  for(let i=0;i<lines.length;i++){
    if(lines[i].toLowerCase().includes("sub_pack")){
      const prev = i>0 ? lines[i-1] : null;
      if(!prev) continue;
      const ts = new Date(prev.split("\t")[0]);
      const nextLine = (i+1)<lines.length ? lines[i+1] : lines[i];
      const amtMatch = nextLine.match(/\d+(\.\d+)?/);
      if(!amtMatch) continue;
      const amt = parseFloat(amtMatch[0]);
      if(PACKS[amt]) purchases.push({purchase_ts: ts, pack_amount: amt, pack_name: PACKS[amt].name});
    }
  }
  return purchases;
}

// Parse claims (multi-line)
function parseClaims(text){
  const lines = text.trim().split('\n').map(l=>l.trim()).filter(l=>l);
  const claims=[];
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    const dateMatch = line.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);
    if(dateMatch){
      if(i<2) continue; 
      const scgcLine = lines[i-2].split("\t");
      if(scgcLine.length<2) continue;
      const sc=parseFloat(scgcLine[0]);
      const gc=parseInt(scgcLine[1]);
      const ts=new Date(dateMatch[0]);
      let pack_name=null;
      for(let amt in PACKS){
        if(PACKS[amt].sc===sc && PACKS[amt].gc===gc){ pack_name=PACKS[amt].name; break; }
      }
      if(pack_name) claims.push({claim_ts: ts, sc, gc, pack_name});
    }
  }
  return claims;
}

// Utility
function addDays(date, days){ return new Date(date.getTime() + days*24*60*60*1000); }
function toUTC8(date){ return new Date(date.getTime() + UTC_OFFSET*3600*1000); }

// Compute subscription intervals
function computeIntervals(purchases){
  const intervals=[];
  for(let amt in PACKS){
    const packName=PACKS[amt].name;
    let packPurchases=purchases.filter(p=>p.pack_amount==parseFloat(amt)).sort((a,b)=>a.purchase_ts-b.purchase_ts);
    let currentEnd=null;
    for(let p of packPurchases){
      let start=p.purchase_ts;
      if(currentEnd && start<=currentEnd) start=currentEnd;
      let end=addDays(start,SUB_DURATION_DAYS);
      intervals.push({pack_name: packName, pack_amount: parseFloat(amt), purchase_ts:p.purchase_ts, start, end});
      currentEnd=end;
    }
  }
  return intervals.sort((a,b)=>a.start-b.start);
}

// Compute Day1-Day7 windows
function computeDayWindows(start){
  const windows=[];
  const startUTC8=toUTC8(start);
  for(let i=0;i<SUB_DURATION_DAYS;i++){
    let dayStartUTC8, dayEndUTC8;
    if(i===0){
      dayStartUTC8=startUTC8;
      dayEndUTC8=new Date(dayStartUTC8); dayEndUTC8.setHours(24,0,0,0);
    } else {
      dayStartUTC8=new Date(startUTC8); dayStartUTC8.setHours(0,0,0,0); dayStartUTC8.setDate(dayStartUTC8.getDate()+i);
      dayEndUTC8=addDays(dayStartUTC8,1);
    }
    windows.push({day_label:`Day${i+1}`, day_start:new Date(dayStartUTC8.getTime()-UTC_OFFSET*3600*1000), day_end:new Date(dayEndUTC8.getTime()-UTC_OFFSET*3600*1000)});
  }
  return windows;
}

// Map claims to subscription
function mapClaims(interval, claims){
  const windows=computeDayWindows(interval.start);
  const results=[];
  for(let w of windows){
    let claim=claims.find(c=>c.pack_name===interval.pack_name && c.claim_ts>=w.day_start && c.claim_ts<w.day_end);
    results.push({
      day_label:w.day_label,
      status: claim?"Claimed":"Missed",
      claim_utc8: claim?toUTC8(claim.claim_ts):null
    });
  }
  return results;
}

// Create HTML table
function createTable(interval, dayResults){
  const table=document.createElement("table");
  
  // Row 1: Main header
  const header=table.insertRow();
  const th=document.createElement("th"); 
  th.colSpan=2; 
  th.className="header"; 
  th.innerText=interval.pack_name; 
  header.appendChild(th);

  // Row 2: Purchase info
  const pRow=table.insertRow();
  pRow.insertCell().innerText=`Backend: ${formatDate(interval.purchase_ts)}`;
  pRow.insertCell().innerText=`Server Time: ${formatDate(toUTC8(interval.purchase_ts))}`;

  // Row 3: Days header
  const subHeader=table.insertRow();
  const cell1=subHeader.insertCell();
  cell1.innerText="Backend (UTC-0)";
  const cell2=subHeader.insertCell();
  cell2.innerText="PST (UTC-8)";
  subHeader.className="subheader";

  // Rows 4-10: Day1-Day7
  dayResults.forEach(d=>{
    const row=table.insertRow();
    row.insertCell().innerText=`${d.day_label}: ${d.status}`;
    row.insertCell().innerText=d.claim_utc8?`${formatDate(d.claim_utc8)}`:"";
  });

  return table;
}

// Main analyzer
function analyze(){
  const purchases=parsePurchases(document.getElementById("purchaseData").value);
  const claims=parseClaims(document.getElementById("claimData").value);
  const intervals=computeIntervals(purchases);
  const resultsDiv=document.getElementById("results");
  resultsDiv.innerHTML="";
  intervals.forEach(interval=>{
    const dayResults=mapClaims(interval,claims);
    resultsDiv.appendChild(createTable(interval,dayResults));
  });
}
</script>

</body>
</html>
