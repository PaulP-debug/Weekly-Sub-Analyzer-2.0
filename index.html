<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subscription Analyzer</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
textarea { width: 100%; height: 120px; margin-bottom: 10px; font-family: monospace; }
button { padding: 10px 20px; font-size: 16px; margin-bottom: 20px; }
.flex-container { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
table { border-collapse: collapse; width: 500px; min-width: 500px; table-layout: fixed; }
th, td { border: 1px solid #333; padding: 5px 10px; text-align: left; word-wrap: break-word; }
th { background-color: #f2f2f2; }
.header { background-color:#d9edf7; font-weight:bold; text-align:center; }
.subheader { background-color:#fcf8e3; font-weight:bold; text-align:center; }
.claimed { background-color:#d4edda; color:#155724; }
.missed { background-color:#f8d7da; color:#721c24; }
td.blank { background-color:#fff; width: 20px; }
td.main { width: 460px; }
</style>
</head>
<body>

<h2>Subscription Analyzer</h2>

<label>Paste Purchase Data:</label>
<textarea id="purchaseData"></textarea>

<label>Paste Claim Data:</label>
<textarea id="claimData"></textarea>

<button onclick="analyze()">Analyze</button>

<div class="flex-container" id="results"></div>

<script>
const PACKS = {
  7.00: {name: "Sub Pack 07"},
  30.00: {name: "Sub Pack 30"},
  90.00: {name: "Sub Pack 90"}
};

function formatDate(date){
  if(!date) return "-";
  const pad = n => n.toString().padStart(2,"0");
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

// Parse purchase data
function parsePurchases(text){
  const lines = text.trim().split("\n").map(l=>l.trim()).filter(l=>l);
  const purchases=[];
  for(let i=0;i<lines.length;i++){
    if(lines[i].toLowerCase().includes("sub_pack")){
      const prev = i>0 ? lines[i-1] : null;
      if(!prev) continue;
      const ts = new Date(prev.split("\t")[0]);
      const nextLine = (i+1)<lines.length ? lines[i+1] : lines[i];
      const amtMatch = nextLine.match(/\d+(\.\d+)?/);
      if(!amtMatch) continue;
      const amt = parseFloat(amtMatch[0]);
      if(PACKS[amt]) purchases.push({purchase_ts: ts, pack_amount: amt, pack_name: PACKS[amt].name});
    }
  }
  return purchases;
}

// Parse claim data
function parseClaims(text){
  const lines = text.trim().split("\n").map(l=>l.trim()).filter(l=>l);
  const claims=[];
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    const dateMatch = line.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);
    if(dateMatch){
      const ts = new Date(dateMatch[0]);
      if(i>=2){
        const scgc = lines[i-2].split("\t");
        const sc = parseFloat(scgc[0]);
        const gc = parseInt(scgc[1]);
        let pack_name=null;
        for(let amt in PACKS){
          if(PACKS[amt]) pack_name=PACKS[amt].name;
        }
        claims.push({claim_ts: ts, pack_name: pack_name});
      }
    }
  }
  return claims;
}

// Compute intervals with extension
function computeIntervals(purchases){
  const intervals=[];
  for(let amt in PACKS){
    const packName = PACKS[amt].name;
    let packPurchases = purchases.filter(p=>p.pack_amount==parseFloat(amt)).sort((a,b)=>a.purchase_ts-b.purchase_ts);
    let currentStart = null;
    let currentEnd = null;
    let subscriptionCount=0;
    for(let p of packPurchases){
      if(!currentStart){
        currentStart = p.purchase_ts;
        currentEnd = new Date(currentStart.getTime());
        subscriptionCount++;
      } else {
        if(p.purchase_ts <= currentEnd){
          subscriptionCount++;
        } else {
          intervals.push({pack_name: packName, start_ts: currentStart, subscriptions: subscriptionCount, claims: []});
          currentStart = p.purchase_ts;
          currentEnd = new Date(currentStart.getTime());
          subscriptionCount =1;
        }
      }
      currentEnd.setDate(currentEnd.getDate()+7);
    }
    if(currentStart) intervals.push({pack_name: packName, start_ts: currentStart, subscriptions: subscriptionCount, claims: []});
  }
  return intervals;
}

// Compute day windows
function computeDayWindows(interval){
  const windows=[];
  let start = new Date(interval.start_ts);
  const total_days = interval.subscriptions*7;
  for(let i=0;i<total_days;i++){
    let dayEnd = new Date(start);
    if(i===0){
      if(start.getHours()<8) dayEnd.setHours(8,0,0,0);
      else { dayEnd.setDate(dayEnd.getDate()+1); dayEnd.setHours(8,0,0,0);}
    } else {
      dayEnd.setDate(dayEnd.getDate()+1);
      dayEnd.setHours(8,0,0,0);
    }
    windows.push({day_label:`Day${i+1}`, start:new Date(start), end:dayEnd});
    start = new Date(dayEnd);
  }
  return windows;
}

// Map claims
function mapClaims(interval, claims, totalMaxDays){
  const windows = computeDayWindows(interval);
  const results=[];
  for(let i=0;i<totalMaxDays;i++){
    const w = windows[i] || {day_label:`Day${i+1}`, start:null, end:null};
    let status="Missed";
    if(w.start){
      for(let c of claims){
        if(c.pack_name===interval.pack_name && c.claim_ts>=w.start && c.claim_ts<w.end){
          status=formatDate(c.claim_ts);
          break;
        }
      }
    }
    results.push({day_label:w.day_label, start:w.start, end:w.end, status});
  }
  return results;
}

// Create table
function createTable(interval, dayResults){
  const table = document.createElement("table");
  const header = table.insertRow();
  const th = document.createElement("th");
  th.colSpan=2; th.className="header"; th.innerText=interval.pack_name; header.appendChild(th);

  // Total row
  const totalRow = table.insertRow();
  const cell1 = totalRow.insertCell();
  cell1.innerText = `Total: ${interval.subscriptions*7} day${interval.subscriptions*7>1?'s':''}`;
  cell1.style.backgroundColor="#d1ecf1"; cell1.style.fontWeight="bold";
  cell1.className="main";
  totalRow.insertCell().className="blank";

  // Start/End row
  const seRow = table.insertRow();
  const endDate = dayResults.find(d=>d.start)?.end || new Date(interval.start_ts.getTime()+interval.subscriptions*7*24*60*60*1000);
  const seCell = seRow.insertCell();
  seCell.innerText = `Start: ${formatDate(interval.start_ts)} | End: ${formatDate(endDate)}`;
  seCell.className="main";
  seRow.insertCell().className="blank";

  // Subheader
  const subHeader = table.insertRow();
  const subCell = subHeader.insertCell();
  subCell.innerText="Day | Day Range | Status";
  subCell.className="main";
  subHeader.insertCell().className="blank";
  subHeader.className="subheader";

  // Day rows
  dayResults.forEach(d=>{
    const row = table.insertRow();
    const cell = row.insertCell();
    if(d.start && d.end){
      cell.innerText=`${d.day_label} | ${formatDate(d.start)} â†’ ${formatDate(d.end)} | ${d.status}`;
      cell.className = d.status!=="Missed" ? "claimed":"missed";
    } else {
      cell.innerText=`${d.day_label} | - | ${d.status}`;
      cell.className="missed";
    }
    row.insertCell().className="blank";
    cell.className="main";
  });

  return table;
}

// Main analyzer
function analyze(){
  const purchases = parsePurchases(document.getElementById("purchaseData").value);
  const claims = parseClaims(document.getElementById("claimData").value);
  const intervals = computeIntervals(purchases);

  intervals.forEach(interval=>{
    interval.claims = claims;
  });

  const totalMaxDays = Math.max(...intervals.map(i=>i.subscriptions*7));

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML="";
  intervals.forEach(interval=>{
    const dayResults = mapClaims(interval, claims, totalMaxDays);
    resultsDiv.appendChild(createTable(interval, dayResults));
  });
}
</script>

</body>
</html>
