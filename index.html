function processSubPacks() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();

  const dataRange = sheet.getRange(4, 1, sheet.getLastRow() - 3, 7);
  const rows = dataRange.getValues();

  const output = [];

  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];

    const purchaseTime = parseDate(r[0]);
    const purchaseAmount = Number(r[6]);

    if (!purchaseTime || isNaN(purchaseAmount)) {
      output.push(["", "", "", "", "", "", ""]);
      continue;
    }

    const dayRanges = buildDayRanges(purchaseTime);

    const claimTime = parseDate(r[1]);
    let dayHit = "";

    if (claimTime) {
      for (let d = 0; d < 7; d++) {
        if (claimTime >= dayRanges[d].start && claimTime < dayRanges[d].end) {
          dayHit = d + 1;
          break;
        }
      }
    }

    output.push([
      formatDate(purchaseTime),
      formatDate(claimTime),
      dayHit,
      formatDate(dayRanges[0].start),
      formatDate(dayRanges[0].end),
      "7-day sub pack",
      purchaseAmount
    ]);
  }

  sheet.getRange(4, 9, output.length, 7).setValues(output);
}

function buildDayRanges(purchaseTime) {
  const resetHour = 8;

  const p = new Date(purchaseTime);
  const sameDayReset = new Date(p.getFullYear(), p.getMonth(), p.getDate(), resetHour, 0, 0);

  let day1End;

  if (purchaseTime < sameDayReset) {
    day1End = sameDayReset;
  } else {
    day1End = new Date(sameDayReset.getTime() + 24 * 60 * 60 * 1000);
  }

  const days = [];
  let start = new Date(purchaseTime);
  let end = day1End;

  for (let d = 0; d < 7; d++) {
    if (d > 0) {
      start = end;
      end = new Date(start.getTime() + 24 * 60 * 60 * 1000);
    }
    days.push({ start, end });
  }

  return days;
}

function parseDate(v) {
  if (!v) return null;
  if (v instanceof Date) return v;

  const t = new Date(v);
  return isNaN(t.getTime()) ? null : t;
}

function formatDate(d) {
  if (!d) return "";
  const pad = (n) => (n < 10 ? "0" + n : n);

  return (
    d.getFullYear() + "-" +
    pad(d.getMonth() + 1) + "-" +
    pad(d.getDate()) + " " +
    pad(d.getHours()) + ":" +
    pad(d.getMinutes()) + ":" +
    pad(d.getSeconds())
  );
}
